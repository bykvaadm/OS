# Пояснительная записка к л\р №2

Небольшое отступление: данная л\р является синтетической.
Некторые вещи которые здесь описаны можно сделать гораздо проще, но поскольку задача л/р - познакомиться
с функционалом raid, lvm то некоторые вещи искуственно усложнены.

## Требования к инструментам для выполнения л\р:

* Средства виртуализации, например Virtualbox
* Установленная виртуальная машина с ОС Linux, например Debian 9
* Наличие интернета для скачивания нескольких пакетов
* Подключение по ssh к установленной VM

## ВНИМАНИЕ

Данная лабораторная работа связана с такой тонкой материей как сохранность данных - это такая область,
которая позволяет из-за мельчайшей ошибки - одной лишней буквы или цифры потерять все ваши данные.
Поскольку вы выполняете лабораторную работу вам ничего не грозит, разве что придется начать делать ее заново.
В реальной жизни все гораздо серьезнее, поэтому следует очень внимательно вводить имена дисков, понимая
что именно вы выполняете текущей командой и с какими дисками работаете.

## Лабораторная работа состоит из 3-х частей:

* настройка работоспособной системы с использованием lvm, raid
* эмуляция отказа одного из дисков
* замена дисков на лету, с добавлением новых дисков и переносом разделов.

## Задание 1 (Установка ОС и настройка LVM, RAID)

1) Создайте новую виртуальную машину, выдав ей следующие характеристики:
* 1 gb ram
* 1 cpu
* 2 hdd (назвать их ssd1, ssd2 и назначить равный размер, поставить галочки hot swap и ssd)

![select ssd disks](https://raw.githubusercontent.com/bykvaadm/OS/master/admin/lab2/images/disks-ssd.png)


2) Начать установку Linux и дойдя до выбора жестких дисков сделать следующее:
* Partitioning method: manual, после чего вы должны увидеть такую картину:
![partition disks](https://raw.githubusercontent.com/bykvaadm/OS/master/admin/lab2/images/VirtualBox_lab2_18_03_2019_17_21_05.png)
* Настройка отдельного раздела под /boot: Выберите первый диск и создайте на нем новую таблицу разделов
  * Partition size: 512M
  * Mount point: /boot
  * Повторите настройку для второго диска, в итоге получив следующее:
    ![partition disks](https://raw.githubusercontent.com/bykvaadm/OS/master/admin/lab2/images/VirtualBox_lab_2_20_03_2019_23_49_16.png)
* Настройка RAID: 
  * Выберите свободное место на первом диске и настройте в качестве типа раздела physical volume for RAID
  * Выберите "Done setting up the partition"
  * Повторите точно такую же настройку для второго диска, в результате получив следующее:
  ![partition disks](https://raw.githubusercontent.com/bykvaadm/OS/master/admin/lab2/images/VirtualBox_lab_2_20_03_2019_23_58_28.png)
  * Выберите пункт "Configure software RAID"
    * Create MD device
    * Software RAID device type: Выберите зеркальный массив
    * Active devices for the RAID XXXX array: Выбрать оба диска
    * Spare devices: Оставить 0 по умолчанию
    * Finish
  * В итоге вы должны получить такую картину:
  ![partition disks](https://raw.githubusercontent.com/bykvaadm/OS/master/admin/lab2/images/VirtualBox_lab_2_21_03_2019_00_01_49.png)
* Настройка LVM: Выберите Configure the Logical Volume Manager
  * Keep current partition layout and configure LVM: Yes
  * Create volume group
  * Volume group name: system
  * Devices for the new volume group: Выберите ваш созданный RAID
  * Create logical volume
    * logical volume name: root
    * logical volume size: 2\5 от размера вашего диска
  * Create logical volume
    * logical volume name: var
    * logical volume size: 2\5 от размера вашего диска
  * Create logical volume
    * logical volume name: log
    * logical volume size: 1\5 от размера вашего диска
  * Выбрав Display configuration details вы должны получить следующую картину:
  ![partition disks](https://raw.githubusercontent.com/bykvaadm/OS/master/admin/lab2/images/VirtualBox_lab2_18_03_2019_17_46_46.png)
  * Завершив настройку LVM вы должны увидеть следующее:
  ![partition disks](https://raw.githubusercontent.com/bykvaadm/OS/master/admin/lab2/images/VirtualBox_lab_2_21_03_2019_00_08_58.png)
* Разметка разделов: по-очереди выберите каждый созданный в LVM том и разметьте их, например, для root так:
  * Use as: ext4
  * mount point: /
  * результат разметки корневого раздела должен получиться таким:
  ![partition disks](https://raw.githubusercontent.com/bykvaadm/OS/master/admin/lab2/images/VirtualBox_lab2_18_03_2019_17_47_38.png)
  * повторите операцию разметки для var и log выбрав соответствующие точки монтирования (/var и /var/log вручную ввести), получив следующий результат:
  ![partition disks](https://raw.githubusercontent.com/bykvaadm/OS/master/admin/lab2/images/VirtualBox_lab_2_21_03_2019_00_13_59.png)
  * Поскольку одновременно монтировать 2 раза /boot нельзя, то зайдите в свойства этого раздела на втором диске
    и выберите mount point: none
  * Выберите Finish Partitioning
* Финальный результат должен получиться вот таким:
![partition disks](https://raw.githubusercontent.com/bykvaadm/OS/master/admin/lab2/images/VirtualBox_lab2_18_03_2019_17_48_31.png)

3) Закончить установку ОС, поставив grub на первое устройство (sda) и перезагрузиться
4) Выполнить установку grub на второе устройство:
* посмотреть диски в системе: fdisk -l
* Перечислите все диски которые вам выдала предыдущая команда и опишите что это за диск
* Найдите диск на который не была выполнена установка grub и выполните эту установку:
```grub-install /dev/XXX```
где ХХХ - найденный диск.
* просмотрите информацию о текущем raid командой cat /proc/mdstat и запишите что вы увидели.
* посмотрите выводы команд: pvs, vgs, lvs, mount и запишите что именно вы увидели

Опишите своими словами что вы сделали и какой результат получили в итоге проделанного задания

После выполнения этого задания рекомендуется сохранить резервную копию папки с виртуальной машиной или сделать
vagrant box: https://t.me/bykvaadm/191

Результат: Виртуальная машина с дисками ssd1, ssd2

## Задание 2 (Эмуляция отказа одного из дисков)

1) Если вы поставили галочку hot swap, то вам доступно удаление дисков на лету
* Выполните удаление диска ssd1 в свойствах машины
* Найдите директорию, где хранятся файлы вашей виртуальной машины и удалите  ssd1.vmdk
2) Убедитесь что ваша виртуальная машина по-прежнему работает
3) Выполните перезагрузку виртуальной машины и убедитесь что она по-прежнему работает
4) проверьте статус RAID-массива: cat /proc/mdstat
7) добавьте в интерфейсе VM новый диск такого же размера и назовите его ssd3
8) выполните операции:
* посмотрите что новый диск приехал в систему командой fdisk -l
* скопируйте таблицу разделов со старого диска на новый: sfdisk -d /dev/XXXX | sfdisk /dev/YYY
* посмотрите результат командой fdisk -l
* Добавьте в рейд массив новый диск: mdadm --manage /dev/md0 --add /dev/YYY
* Посмотрите результат: cat /proc/mdstat. Вы должны увидеть что началась синхронизация
9) Теперь нужно вручную выполните синхронизацию разделов, не входящих в RAID.
Для этого воспользуемся утилитой dd, скопировав с "живого" диска на новенький, который вы недавно поставили
```
dd if=/dev/XXX of=/dev/YYY
```
10) После завершнения синхронизации установите grub на новый диск
11) Выполните перезагрузку ВМ, для того чтобы убедиться что все работает

Опишите своими словами что вы сделали и какой результат получили в ите проделанного задания

Результат: Удален диск ssd1, сохранен диск ssd2, добавлен диск ssd3.

## Задание 3 (Добавление новых дисков и перенос раздела) (В РАЗРАБОТКЕ)

Это самое сложное и объемное задание из всех представленных.
Очень внимательно проверяйте что вы делаете и с какими дисками и разделами.
Рекомендуется снять копию перед его выполнением.
Это задание независимо от задания №2, его можно выполнять после задания №1.

К истории...

Представьте себе что ваш сервер работал долгое время на 2-х ssd дисках, как вдруг...

1) Проэмулируйте отказ диска ssd2, удалив соответствующую vmdk, удалив из свойств ВМ диск и перезагрузившись
2) Посмотрите текущее состояние дисков и RAID:
```
cat /proc/mdstat
fdisk -l
lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT
```
3) Вам повезло - начальство разрешило закупить несколько новых дисков:

2 SATA большого объема для давно назревшей задачи вынесения раздела с логами на отдельный диск

2 SSD на замену погибшему, а также на замену пока еще функционирующему.

Следует учитывать, что корзина сервера поддерживает установку только 4х дисков одновременно,
поэтому добавить все диски сразу нельзя.

Объем HDD выбрать в 2 раза больше чем SSD.
Объем SSD выбрать в 1,25 раза больше бывших SSD.

4) Добавьте один новый ssd диск, назвав его ssd4, а после добавления проверьте что произошло:
```
fdisk -l
lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT
```
5) В первую очередь следует озаботиться сохранностью данных старого диска.
На этот раз мы будем переносить данные с помощью LVM:
* в первую очередь необходимо скопировать файловую таблицу со старого диска на новый:
  ```
  sfdisk -d /dev/XXX | sfdisk /dev/YYY
  ```
  Подставьте вместо x,y правильные диски и разберите что делает данная команда.
* Выполните команду lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT и сравните ее вывод с прошлым вызовом.
  Что поменялось?
* с помощью команды dd скопируйте данные /boot на новый диск
  ```
  dd if=/dev/XXX of=/dev/YYY
  ```
* Установите загрузчик на новый ssd диск
  ```
  grub-install /dev/YYY
  ```
  Зачем мы выполняем эту операцию?
* создайте новый рейд-массив с включением туда только одного нового ssd диска:
  ```
  mdadm --create --verbose /dev/md63 --level=1 --raid-devices=1 /dev/YYY
  ```
  Команда приведенная выше не отработает без указания специального ключа.
  Прочитайте справку и добавьте этот ключ к команде.
* С помощью команды cat /proc/mdstat проверьте результат вашей операции. Что поменялось?
* Выполните команду lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT и сравните ее вывод с прошлым вызовом.
  Что поменялось?
6) Следующим этапом необходимо настроить LVM
* выполните команду pvs для просмотра информации о текущих физических томах
* создайте новый физический том включив в него ранее созданный RAID массив:
  ```
  pvcreate /dev/md63
  ```
* Выполните команду lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT и сравните ее вывод с прошлым вызовом.
  Что поменялось?
* Снова выполните команду pvs. Что поменялось?
* Увеличим размер Volume Group system с помощью такой команды:
  ```
  vgextend system /dev/md63
  ```
* Выполните команды и запишите что вы увидели и что поменялось.
  ```
  vgdisplay system -v
  pvs
  vgs
  lvs -a -o+devices
  ```
  На каком физическом диске сейчас находятся LV var,log,root?
* Выполните перемещение данных со старого диска на новый, подставив правильные имена устройств.
  ```
  pvmove -i 10 -n /dev/system/root /dev/md0 /dev/md63 
  ```
  Повторите операцию для всех logical volume
* Выполните команды и запишите что вы увидели и что поменялось.
  ```
  vgdisplay system -v
  pvs
  vgs
  lvs -a -o+devices
  lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT
  ```
* Изменим наш VG, удалив из него диск старого raid. Подставьте правильное имя raid.
  ```
  vgreduce system /dev/md0
  ```
* Выполните команды и запишите что вы увидели и что поменялось.
  ```
  lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT
  pvs
  vgs
  ```
7) удалите ssd3 диск и добавьте ssd5, hdd1, hdd2 согласно вышеописанным ТЗ, в итоге получив:
* ssd4 - первый новый ssd
* ssd5 - второй новый ssd
* hdd1 - первый новый hdd
* hdd2 - второй новый hdd
8) Проверьте что произошло после добавления дисков:
```
fdisk -l
lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT
```
9) скопируйте загрузочный раздел /boot с диска ssd4 на ssd5
```
dd if=/dev/XXX of=/dev/YYY
```
10) Восстановим работу основного raid массива:
* выполните копирование таблицы разделов, подставив правильные диски:
  ```
  sfdisk -d /dev/XXX | sfdisk /dev/YYY
  ```
* Обратите внимание, что когда мы скопировали таблицу разделов со старого диска лказалось что новый размер 
  не использует весь объем жесткого диска.
  Поэтому в скором времени нам потребуется изменить размер этого раздела и расширить raid.
  Убедитесь в этом сами, введя команду:
  ```
  lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT
  ```
11) изменим размер второго раздела диска ssd5
* запустите утилиту для работы с разметкой дисков:
  ```
  fdisk /dev/XXX
  ```
* введите ключ d для того чтобы удалить существующий раздел (выберите 2)
* введите ключ n для того чтобы создать новый раздел
* введите ключ p для того чтобы указать тип раздела "первичный"
* введите ключ 2 для того чтобы новый раздел имел второй номер
* First sector: нажмите enter, чтобы согласиться с атоматически вычесленным размером начала раздела
* Last sector: нажмите enter, чтобы согласиться с атоматически вычесленным размером конца раздела
* введите ключ l для того чтобы увидеть список всех возможных типов разделов и найдите в нем Linux raid auto
* введите ключ t для того чтобы изменить тип созданного раздела (2) и введите найденный на предыдущем шаге номер.
* введите ключ w для того чтобы записать изменение на диск.
12) перечитаем таблицу разделов и проверим результат
```
partx -u /dev/XXX
lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT
```
* добавим новый диск к текущему raid массиву (не забудьте подставить правильные диски)
  ```
  mdadm --manage /dev/md63 --add /dev/sdb3
  ```
* Расширим количество дисков в нашем массиве до 2-х штук:
  ```
  mdadm --grow /dev/md63 --raid-devices=2
  ```
* Посмотрите результат: у нас размечено 2 массива, но оба раздела входящие в этот массив имеют разные размеры
 ```
  lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT
  ```
13) увеличим размер раздела на диске ssd4
* запустите утилиту для работы с разметкой дисков:
  ```
  fdisk /dev/XXX
  ```
* введите ключ d для того чтобы удалить существующий раздел (выберите 2)
* введите ключ n для того чтобы создать новый раздел
* введите ключ p для того чтобы указать тип раздела "первичный"
* введите ключ 2 для того чтобы новый раздел имел второй номер
* First sector: нажмите enter, чтобы согласиться с атоматически вычесленным размером начала раздела
* Last sector: нажмите enter, чтобы согласиться с атоматически вычесленным размером конца раздела
* В конце разметки следует выбрать No, чтобы оставить сигнатуру принадлежности раздела к массиву.
* введите ключ w для того чтобы записать изменение на диск.
12) перечитаем таблицу разделов и проверим результат
```
partx -u /dev/XXX
lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT
```

raid-массива на новом диске

pvresize

